// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© Edgerunner Trading System

//@version=6
indicator("Edgerunner Normalized ROC [Timeframe Adaptive]", shorttitle="ER-NROC", overlay=false)

// Timeframe Adaptation Settings
timeframeMultiplier = input.float(1.0, "Timeframe Multiplier", minval=0.1, maxval=10, step=0.1, tooltip="Adjust for different timeframes: 0.2 for 1H (daily/6), 1.0 for Daily, 5 for Weekly")

// Base period (optimized for daily)
baseROCPeriod = 20
baseATRPeriod = 20

// Adjusted periods based on timeframe
rocPeriod = math.round(baseROCPeriod * timeframeMultiplier)
atrPeriod = math.round(baseATRPeriod * timeframeMultiplier)

// Threshold Settings
upperRef = input.float(3.0, "Upper Reference", minval=1, maxval=10, step=0.5, tooltip="Overbought threshold - indicates outsized upward move")
lowerRef = input.float(-3.0, "Lower Reference", minval=-10, maxval=-1, step=0.5, tooltip="Oversold threshold - indicates outsized downward move")

// Additional Settings
showAbsolute = input.bool(false, "Show Absolute Values", tooltip="Display absolute ROC values alongside normalized")
smoothing = input.int(1, "Smoothing Period", minval=1, maxval=10)

// Calculate Rate of Change
roc = (close - close[rocPeriod]) / close[rocPeriod] * 100

// Calculate ATR
atr = ta.atr(atrPeriod)

// Normalize ROC by ATR
// Convert ATR to percentage of price for normalization
atrPercent = (atr / close) * 100
normalizedROC = atrPercent != 0 ? roc / atrPercent : 0

// Apply smoothing
smoothedNROC = ta.sma(normalizedROC, smoothing)

// Determine signal
signal = smoothedNROC > upperRef ? 1 : 
         smoothedNROC < lowerRef ? -1 : 0

// Colors
nrocColor = signal == 1 ? color.red : 
            signal == -1 ? color.green : 
            smoothedNROC > 0 ? color.new(color.orange, 50) : 
            smoothedNROC < 0 ? color.new(color.blue, 50) : color.gray

// Plot Normalized ROC
plot(smoothedNROC, title="Normalized ROC", color=nrocColor, linewidth=2)

// Plot absolute ROC for reference (optional)
plot(showAbsolute ? roc : na, title="Absolute ROC", color=color.new(color.purple, 70), linewidth=1)

// Reference lines
h1 = hline(upperRef, "Upper Reference", color=color.new(color.red, 50), linestyle=hline.style_dotted)
h2 = hline(lowerRef, "Lower Reference", color=color.new(color.green, 50), linestyle=hline.style_dotted)
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_solid)

// Additional reference lines for extreme values
hline(5, "Extreme High", color=color.new(color.red, 70), linestyle=hline.style_dotted)
hline(-5, "Extreme Low", color=color.new(color.green, 70), linestyle=hline.style_dotted)

// Fill areas
fill(h1, h2, color=color.new(color.gray, 95), title="Normal Range")

// Background coloring for outsized moves
bgcolor(signal == 1 ? color.new(color.red, 95) : na, title="Outsized Up Move")
bgcolor(signal == -1 ? color.new(color.green, 95) : na, title="Outsized Down Move")

// Trend Reversal Detection
// After extended moves, an outsized move in opposite direction can signal reversal
lookback = input.int(50, "Reversal Lookback", minval=20, maxval=100, group="Reversal Detection")
showReversals = input.bool(true, "Show Potential Reversals", group="Reversal Detection")

// Check for extended up move followed by outsized down move
extendedUp = ta.highest(smoothedNROC, lookback) > upperRef
outsizedDown = smoothedNROC < lowerRef
potentialTopReversal = showReversals and extendedUp and outsizedDown and smoothedNROC == ta.lowest(smoothedNROC, 5)

// Check for extended down move followed by outsized up move
extendedDown = ta.lowest(smoothedNROC, lookback) < lowerRef
outsizedUp = smoothedNROC > upperRef
potentialBottomReversal = showReversals and extendedDown and outsizedUp and smoothedNROC == ta.highest(smoothedNROC, 5)

plotshape(potentialTopReversal, title="Potential Top Reversal", style=shape.triangledown, 
    location=location.top, color=color.red, size=size.normal)
plotshape(potentialBottomReversal, title="Potential Bottom Reversal", style=shape.triangleup, 
    location=location.bottom, color=color.green, size=size.normal)

// Histogram visualization
histColor = smoothedNROC > 0 ? color.new(color.orange, 80) : color.new(color.blue, 80)
plot(smoothedNROC, title="NROC Histogram", style=plot.style_histogram, color=histColor, linewidth=1)

// Information table
var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 90))
if barstate.islast
    table.cell(infoTable, 0, 0, "ROC Period:", text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(rocPeriod), text_color=color.white)
    table.cell(infoTable, 0, 1, "ATR Period:", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(atrPeriod), text_color=color.white)
    table.cell(infoTable, 0, 2, "Abs ROC:", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(roc, "#.##") + "%", text_color=color.purple)
    table.cell(infoTable, 0, 3, "ATR %:", text_color=color.white)
    table.cell(infoTable, 1, 3, str.tostring(atrPercent, "#.##") + "%", text_color=color.white)
    table.cell(infoTable, 0, 4, "Norm ROC:", text_color=color.white)
    table.cell(infoTable, 1, 4, str.tostring(smoothedNROC, "#.##"), text_color=nrocColor)
    table.cell(infoTable, 0, 5, "Signal:", text_color=color.white)
    
    signalText = signal == 1 ? "OUTSIZED UP" : 
                 signal == -1 ? "OUTSIZED DOWN" : 
                 smoothedNROC > 1 ? "Above Normal" :
                 smoothedNROC < -1 ? "Below Normal" : "NORMAL"
    signalColor = signal == 1 ? color.red : 
                  signal == -1 ? color.green : 
                  smoothedNROC > 1 ? color.new(color.orange, 50) :
                  smoothedNROC < -1 ? color.new(color.blue, 50) : color.gray
    
    table.cell(infoTable, 1, 5, signalText, text_color=signalColor)

// Alerts
alertcondition(ta.crossover(smoothedNROC, upperRef), 
    title="Outsized Up Move", message="Normalized ROC crossed above upper reference - Outsized upward move")
alertcondition(ta.crossunder(smoothedNROC, lowerRef), 
    title="Outsized Down Move", message="Normalized ROC crossed below lower reference - Outsized downward move")
alertcondition(potentialTopReversal, 
    title="Potential Top Reversal", message="Potential trend reversal from top detected")
alertcondition(potentialBottomReversal, 
    title="Potential Bottom Reversal", message="Potential trend reversal from bottom detected")
alertcondition(smoothedNROC > 5, 
    title="Extreme Up Move", message="Normalized ROC above 5 - Extreme upward move")
alertcondition(smoothedNROC < -5, 
    title="Extreme Down Move", message="Normalized ROC below -5 - Extreme downward move")
// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© Edgerunner Trading System

//@version=6
indicator("Edgerunner RSI Trend Range [Timeframe Adaptive]", shorttitle="ER-RSI-TR", overlay=false)

// Timeframe Adaptation Settings
timeframeMultiplier = input.float(1.0, "Timeframe Multiplier", minval=0.1, maxval=10, step=0.1, tooltip="Adjust for different timeframes: 0.2 for 1H (daily/6), 1.0 for Daily, 5 for Weekly")

// Base period (optimized for daily)
baseRSIPeriod = 65  // ~3 months for daily

// Adjusted period based on timeframe
rsiPeriod = math.round(baseRSIPeriod * timeframeMultiplier)

// RSI Settings
rsiSmoothing = input.int(5, "RSI Smoothing Period", minval=1)
bullThreshold = input.float(51, "Bull Threshold", minval=50, maxval=100, step=0.5)
bearThreshold = input.float(49, "Bear Threshold", minval=0, maxval=50, step=0.5)

// Calculate RSI
rsiValue = ta.rsi(close, rsiPeriod)

// Apply smoothing to reduce whipsaws
smoothedRSI = ta.sma(rsiValue, rsiSmoothing)

// Determine trend signal
trendSignal = smoothedRSI > bullThreshold ? 1 : smoothedRSI < bearThreshold ? -1 : 0

// Color based on trend
rsiColor = trendSignal == 1 ? color.green : trendSignal == -1 ? color.red : color.gray

// Plot RSI
plot(smoothedRSI, title="RSI Trend Range", color=rsiColor, linewidth=2)

// Plot thresholds
h1 = hline(bullThreshold, "Bull Threshold", color=color.new(color.green, 50), linestyle=hline.style_dotted)
h2 = hline(bearThreshold, "Bear Threshold", color=color.new(color.red, 50), linestyle=hline.style_dotted)
hline(50, "Midline", color=color.gray, linestyle=hline.style_solid)

// Fill between thresholds (neutral zone)
fill(h1, h2, color=color.new(color.gray, 90), title="Neutral Zone")

// Additional reference lines
hline(70, "Strong Bull", color=color.new(color.green, 70), linestyle=hline.style_dotted)
hline(30, "Strong Bear", color=color.new(color.red, 70), linestyle=hline.style_dotted)

// Background coloring for trend
bgcolor(trendSignal == 1 ? color.new(color.green, 95) : na, title="Bullish Background")
bgcolor(trendSignal == -1 ? color.new(color.red, 95) : na, title="Bearish Background")

// Divergence Detection (optional)
lookback = input.int(20, "Divergence Lookback", minval=5, maxval=50)
showDivergence = input.bool(false, "Show Divergences")

// Bullish divergence: price makes lower low, RSI makes higher low
priceLow = ta.lowest(low, lookback)
rsiLow = ta.lowest(smoothedRSI, lookback)
bullishDiv = showDivergence and (low == priceLow and low < low[lookback]) and 
    (smoothedRSI == rsiLow and smoothedRSI > smoothedRSI[lookback])

// Bearish divergence: price makes higher high, RSI makes lower high
priceHigh = ta.highest(high, lookback)
rsiHigh = ta.highest(smoothedRSI, lookback)
bearishDiv = showDivergence and (high == priceHigh and high > high[lookback]) and 
    (smoothedRSI == rsiHigh and smoothedRSI < smoothedRSI[lookback])

// Plot divergence signals
plotshape(bullishDiv, title="Bullish Divergence", style=shape.triangleup, location=location.bottom, 
    color=color.green, size=size.small)
plotshape(bearishDiv, title="Bearish Divergence", style=shape.triangledown, location=location.top, 
    color=color.red, size=size.small)

// Information table
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 90))
if barstate.islast
    table.cell(infoTable, 0, 0, "RSI Period:", text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(rsiPeriod), text_color=color.white)
    table.cell(infoTable, 0, 1, "Smoothing:", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(rsiSmoothing), text_color=color.white)
    table.cell(infoTable, 0, 2, "RSI Value:", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(smoothedRSI, "#.##"), text_color=rsiColor)
    table.cell(infoTable, 0, 3, "Trend:", text_color=color.white)
    
    trendText = trendSignal == 1 ? "UPTREND" : trendSignal == -1 ? "DOWNTREND" : "NEUTRAL"
    table.cell(infoTable, 1, 3, trendText, text_color=rsiColor)
    
    table.cell(infoTable, 0, 4, "Strength:", text_color=color.white)
    strengthText = smoothedRSI > 70 ? "STRONG UP" : 
                   smoothedRSI < 30 ? "STRONG DOWN" : 
                   smoothedRSI > 60 ? "MODERATE UP" :
                   smoothedRSI < 40 ? "MODERATE DOWN" : "NEUTRAL"
    strengthColor = smoothedRSI > 70 ? color.green : 
                    smoothedRSI < 30 ? color.red :
                    smoothedRSI > 60 ? color.new(color.green, 30) :
                    smoothedRSI < 40 ? color.new(color.red, 30) : color.gray
    table.cell(infoTable, 1, 4, strengthText, text_color=strengthColor)

// Alerts
alertcondition(ta.crossover(smoothedRSI, bullThreshold), 
    title="Uptrend Signal", message="RSI Trend Range crossed above bull threshold - Uptrend signal")
alertcondition(ta.crossunder(smoothedRSI, bearThreshold), 
    title="Downtrend Signal", message="RSI Trend Range crossed below bear threshold - Downtrend signal")
alertcondition(ta.crossover(smoothedRSI, 50), 
    title="Cross Above 50", message="RSI Trend Range crossed above 50")
alertcondition(ta.crossunder(smoothedRSI, 50), 
    title="Cross Below 50", message="RSI Trend Range crossed below 50")
alertcondition(bullishDiv, 
    title="Bullish Divergence", message="Bullish divergence detected")
alertcondition(bearishDiv, 
    title="Bearish Divergence", message="Bearish divergence detected")